---
###############################################################################
# Copyright (c) 2022-25, Lawrence Livermore National Security, LLC and RADIUSS
# project contributors. See the COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
###############################################################################

# GitLab CI Component: Draft PR Filter
#
# This component skips CI execution for draft pull requests on GitHub.
# It queries the GitHub GraphQL API to check if the PR is in draft state
# and fails the pipeline if it is, unless the branch matches the always-run pattern.
#
# Usage:
#   include:
#     - component: $CI_SERVER_FQDN/radiuss/radiuss-shared-ci/utility-draft-pr-filter@v2025.12.0
#       inputs:
#         github_token: $GITHUB_TOKEN
#         github_project_name: "my-project"
#         github_project_org: "LLNL"
#         always_run_pattern: "^develop$|^main$|^master$|^v[0-9.]*$"

spec:
  inputs:
    github_token:
      type: string
      description: "GitHub personal access token for API authentication"

    github_project_name:
      type: string
      description: "GitHub project/repository name"

    github_project_org:
      type: string
      description: "GitHub organization name"

    always_run_pattern:
      type: string
      description: "Regex pattern for branches that should always run CI"
      default: "^develop$|^main$|^master$|^v[0-9.]*$"

---
# Draft PR filter job
ignore-draft-pr:
  stage: .pre
  tags: [shell, oslic]
  variables:
    GIT_STRATEGY: none
  script:
    - |
      # If the current branch is not in the always run pattern
      echo ""
      echo "### Draft filter parameters ###"
      echo "# CI_COMMIT_BRANCH = ${CI_COMMIT_BRANCH}"
      echo "# GITHUB_PROJECT_NAME = $[[ inputs.github_project_name ]]"
      echo "# GITHUB_PROJECT_ORG = $[[ inputs.github_project_org ]]"
      echo "# ALWAYS_RUN_PATTERN = $[[ inputs.always_run_pattern ]]"
      echo "# CI_COMMIT_SHA = ${CI_COMMIT_SHA}"
      echo ""
      description="GitLab: Pull Request vetted for testing"
      status="success"
      return_code=0

      # CI_COMMIT_BRANCH is only empty for tags, we always run CI on tags.
      if [[ ! "${CI_COMMIT_BRANCH}" =~ $[[ inputs.always_run_pattern ]] && -n "${CI_COMMIT_BRANCH}" ]];
      then
          # Check if required variables are set
      if [ -z "$[[ inputs.github_token ]]" ] || [ -z "$[[ inputs.github_project_org ]]" ] || [ -z "$[[ inputs.github_project_name ]]" ]; then
            echo "Error: Required GitHub variables not set"
            exit 1
          fi

          # Query GitHub GraphQL API with error handling
          GRAPHQL_RESPONSE=$(mktemp)
          GRAPHQL_HTTP_CODE=$(curl --retry 3 --retry-delay 5 --max-time 30 \
              --header "authorization: Bearer $[[ inputs.github_token ]]" \
              --header "Content-Type: application/json" \
              -X POST \
              --data "{ \"query\": \"query { repository(name: \\\"$[[ inputs.github_project_name ]]\\\", owner: \\\"$[[ inputs.github_project_org ]]\\\") { pullRequests(last: 1, headRefName: \\\"${CI_COMMIT_BRANCH}\\\") { nodes { number, isDraft } } } }\" }" \
              --output "$GRAPHQL_RESPONSE" \
              --write-out "%{http_code}" \
              --silent \
              --show-error \
              https://api.github.com/graphql)

          echo "GitHub GraphQL API response code: $GRAPHQL_HTTP_CODE"

          if [ "$GRAPHQL_HTTP_CODE" -eq 200 ]; then
            echo "Successfully queried GitHub API"
            # Check if the response contains valid data
            if ! jq -e '.data.repository.pullRequests.nodes[0]' "$GRAPHQL_RESPONSE" > /dev/null 2>&1; then
              echo "Warning: No pull request found for branch ${CI_COMMIT_BRANCH}"
            elif jq -e '.data.repository.pullRequests.nodes[0].isDraft == true' "$GRAPHQL_RESPONSE" > /dev/null; then
              description="GitLab: skipped draft Pull Request"
              status="failure"
              return_code=1
              echo "Pull Request is in draft state, skipping CI"
            else
              echo "Pull Request is not a draft, proceeding with CI"
            fi
          else
            echo "Failed to query GitHub GraphQL API. HTTP status: $GRAPHQL_HTTP_CODE"
            echo "Response body:"
            cat "$GRAPHQL_RESPONSE"
            rm -f "$GRAPHQL_RESPONSE"
            exit 1
          fi

          rm -f "$GRAPHQL_RESPONSE"
      fi

      # Report status to GitHub with error handling
      STATUS_RESPONSE=$(mktemp)
      STATUS_HTTP_CODE=$(curl --retry 3 --retry-delay 5 --max-time 30 \
          --url "https://api.github.com/repos/$[[ inputs.github_project_org ]]/$[[ inputs.github_project_name ]]/statuses/${CI_COMMIT_SHA}" \
          --header 'Content-Type: application/json' \
          --header "authorization: Bearer $[[ inputs.github_token ]]" \
          --data "{ \"state\": \"${status}\", \"target_url\": \"${CI_PIPELINE_URL}\", \"description\": \"${description}\", \"context\": \"ci/gitlab/skipped-draft-pr\" }" \
          --output "$STATUS_RESPONSE" \
          --write-out "%{http_code}" \
          --silent \
          --show-error)

      echo "GitHub Status API response code: $STATUS_HTTP_CODE"

      if [ "$STATUS_HTTP_CODE" -eq 201 ]; then
        echo "Successfully reported status to GitHub"
      else
        echo "Failed to report status to GitHub. HTTP status: $STATUS_HTTP_CODE"
        echo "Response body:"
        cat "$STATUS_RESPONSE"
        rm -f "$STATUS_RESPONSE"
        exit 1
      fi

      rm -f "$STATUS_RESPONSE"
      exit ${return_code}
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: never
    - when: on_success
